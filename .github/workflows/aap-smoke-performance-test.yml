name: K6 Performance Smoke Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 21 * * 1-5'

jobs:
  performance_smoke_test:
    name: Run k6 with Dashboard
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Run self-contained AAP smoke test and export dashboard
        run: |
          docker run --rm \
            -u root:root \
            -v ${{ github.workspace }}:/src \
            # Pass secrets required by k6 setup() for authentication
            -e AAP_CLIENT_ID="${{ secrets.AAP_CLIENT_ID }}" \
            -e AAP_CLIENT_SECRET="${{ secrets.AAP_CLIENT_SECRET }}" \
            -e TOKEN_URL="${{ secrets.TOKEN_URL }}" \
            ghcr.io/grafana/xk6-dashboard:latest \
            run --out 'dashboard=export=aap-perf-report.html&port=-1' /src/performance/tests/aapApi.js
            
      - name: Upload Dashboard Report
        uses: actions/upload-artifact@v4
        with:
          name: k6-dashboard-report
          path: aap-perf-report.html
          retention-days: 1